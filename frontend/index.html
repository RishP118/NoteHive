<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NoteHive – Teacher Dashboard</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#15161a; --ink:#f3f4f6; --muted:#a3a6ad; --line:#272a30;
      --blue:#3b82f6; --green:#10b981; --red:#ef4444; --amber:#f59e0b;
      --ok:#22c55e; --warn:#f97316;
      --r:18px; --shadow:0 10px 30px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:inherit;text-decoration:none}
    button{cursor:pointer}
    .container{max-width:1180px;margin-inline:auto;padding:0 20px}

    /* Top Nav (dark) */
    .nav{position:sticky;top:0;z-index:50;background:rgba(21,22,26,.92);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #111827}
    .nav-inner{height:64px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:12px;background:var(--amber);display:grid;place-items:center;color:#111;font-weight:800}
    .role{padding:.22rem .6rem;border:1px solid #374151;border-radius:999px;color:#cbd5e1;background:#111827;font-size:12px}
    .search{position:relative;flex:1;max-width:560px;margin:0 16px;display:none}
    .search input{width:100%;height:38px;border-radius:999px;border:1px solid #374151;padding:0 40px;background:#111827;color:#e5e7eb}
    .search svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.7}
    .nav-actions{display:flex;align-items:center;gap:10px}

    /* Buttons */
    .btn{display:inline-flex;align-items:center;gap:8px;height:36px;padding:0 14px;border-radius:10px;border:1px solid var(--line);background:#1b1d23;color:var(--ink)}
    .btn i{width:18px;height:18px}
    .btn.ghost{background:transparent;border-color:#374151}
    .btn-blue{background:var(--blue);border-color:transparent}
    .btn-green{background:var(--green);border-color:transparent}
    .btn-red{background:var(--red);border-color:transparent}

    /* Cards & sections */
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .section{padding:22px 0}
    .muted{color:var(--muted)}

    /* Hero */
    .hero{padding:24px 0}
    .hero-card{padding:20px}
    .hero-top{display:flex;flex-direction:column;gap:12px}
    .hero-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#1a2433;color:#93c5fd;font-weight:600;font-size:12px;border:1px solid #1f2d44}
    .primary{background:var(--blue);color:#fff;border-color:transparent}

    /* Quick actions  */
    .quick-grid{margin-top:16px;display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .qa{border:1px solid var(--line);border-radius:14px;padding:14px;background:#20232a;display:flex;gap:10px;align-items:center;transition:box-shadow .2s, transform .1s;cursor:pointer}
    .qa:hover{box-shadow:var(--shadow);transform:translateY(-2px)}
    .qa-icon{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:#2b3038}
    .qa-icon i{width:20px;height:20px}

    /* Two-col rows */
    .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}

    /* Forms */
    .form{display:grid;gap:10px}
    .input,.select,textarea{width:100%;padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1115;color:var(--ink)}
    textarea{min-height:84px;resize:vertical}

    /* Tabs */
    .tabs{padding:14px}
    .tab-list{display:flex;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .tab-btn{flex:1;padding:10px;background:#1b1f27;border:0;border-right:1px solid var(--line);color:#e5e7eb;cursor:pointer}
    .tab-btn.active{background:#232833;font-weight:600}
    .tab-panels{margin-top:12px}
    .panel{display:none}
    .panel.active{display:block}

    /* Lists */
    .list{display:grid;gap:10px}
    .list-row{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:10px;background:#20232a}
    .list-row .btn{height:34px}

    /* Footer */
    footer{border-top:1px solid #111827;background:#0b0c10;margin-top:8px;color:#e5e7eb}
    .foot{display:flex;align-items:center;justify-content:space-between;padding:14px 0;font-size:12px}

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
    .modal{width:min(520px,92vw);background:#0f1115;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);color:#e5e7eb}
    .modal-h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .modal-b{padding:16px}
    .modal-f{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}

    /* Responsive */
    @media (min-width:900px){.search{display:block}}
    @media (max-width:1024px){.quick-grid{grid-template-columns:repeat(2,1fr)}.row{grid-template-columns:1fr}}
    @media (max-width:640px){.quick-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav">
    <div class="container nav-inner">
      <div class="brand">
        <div class="logo">NH</div>
        <strong>NoteHive</strong>
        <span class="role">Teacher</span>
      </div>
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input class="input" type="text" placeholder="Search notes, courses, students…"/>
      </div>
      <div class="nav-actions">
        <button class="btn ghost" title="Notifications"><i data-feather="bell"></i></button>
        <button class="btn btn-blue" id="btn-signin"><i data-feather="log-in"></i> Sign in</button>
        <a class="btn btn-green" id="btn-help" href="help.html"><i data-feather="help-circle"></i> Help</a>
        <button class="btn btn-red" id="btn-logout"><i data-feather="log-out"></i> Logout</button>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <section class="hero">
    <div class="container">
      <div class="card hero-card">
        <div class="hero-top">
          <div>
            <h1 id="welcome-title">Welcome to NoteHive</h1>
            <div class="muted" id="welcome-subtitle">Professional teacher dashboard for Computer Science courses.</div>
          </div>
          <div class="hero-actions">
            <span class="pill"><i data-feather="sparkles"></i> AI Assist</span>
            <button class="btn primary" id="btn-new-note"><i data-feather="plus"></i> New note</button>
          </div>
        </div>

        <div class="quick-grid">
          <div class="qa" id="qa-upload">
            <div class="qa-icon"><i data-feather="upload"></i></div>
            <div><div><strong>Upload Notes</strong></div><div class="muted">PDF / PPTX / DOCX</div></div>
          </div>

          <a class="qa" href="editor.html?mode=docs">
            <div class="qa-icon"><i data-feather="edit-3"></i></div>
            <div><div><strong>Open Note Editor</strong></div><div class="muted">Write / Paste / Publish</div></div>
          </a>

          <a class="qa" href="scheduler.html">
            <div class="qa-icon"><i data-feather="calendar"></i></div>
            <div><div><strong>Open Scheduler</strong></div><div class="muted">Class title • Date • Time</div></div>
          </a>

          <a class="qa" href="session.html">
            <div class="qa-icon"><i data-feather="users"></i></div>
            <div><div><strong>Study Session</strong></div><div class="muted">Create / Join / Collaborate</div></div>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- SECTIONS -->
  <section class="section">
    <div class="container row">
      <!-- Upload Notes -->
      <div class="card" id="upload">
        <div style="padding:16px 16px 0 16px">
          <h2>Upload Notes</h2>
          <div class="muted">Select file(s), set title, choose subject, add description.</div>
        </div>
        <div style="padding:16px" class="form">
          <input type="file" id="file-input" class="input" multiple accept=".pdf,.ppt,.pptx,.doc,.docx"/>
          <input type="text" id="title-input" class="input" placeholder="Title (e.g., Introduction to DBMS)" maxlength="300"/>
          <select id="subject-select" class="select">
            <option>Data Structures</option>
            <option>Operating Systems</option>
            <option>DBMS</option>
            <option>Computer Networks</option>
            <option>ML & DL</option>
            <option>SoftwareEngineering</option>
            <option>Other</option>
          </select>
          <textarea id="desc-input" placeholder="Short description…" class="input" maxlength="1000"></textarea>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn primary" id="btn-upload"><i data-feather="arrow-up-circle"></i> Upload</button>
            <span class="muted">Files validated → Saved → Visible to students</span>
          </div>
          <div id="upload-msg" class="muted"></div>
        </div>
      </div>
      <!-- Note Editor (preview links) -->
      <div class="card" id="editor">
        <div style="padding:16px 16px 0 16px">
          <h2>Note Editor</h2><div class="muted">Write or paste study material. Save draft or publish notes.</div>
        </div>
        <div class="tabs">
          <div class="tab-list" role="tablist">
            <button class="tab-btn active" data-panel="docs">Docs</button>
            <button class="tab-btn" data-panel="check">Checklists</button>
            <button class="tab-btn" data-panel="code">Code & LaTeX</button>
          </div>
          <div class="tab-panels">
            <div id="p-docs" class="panel active">
              <div class="list-row">
                <div><strong>Docs-style notes</strong><div class="muted">Headings, lists, links, images</div></div>
                <a class="btn" href="editor.html?mode=docs"><i data-feather="edit-3"></i> Open Editor</a>
              </div>
            </div>
            <div id="p-check" class="panel">
              <div class="list-row">
                <div><strong>Checklists</strong><div class="muted">Tasks with progress for labs</div></div>
                <a class="btn" href="editor.html?mode=check"><i data-feather="edit-3"></i> Open Editor</a>
              </div>
            </div>
            <div id="p-code" class="panel">
              <div class="list-row">
                <div><strong>Code blocks & LaTeX</strong><div class="muted">Syntax highlighting & equations</div></div>
                <a class="btn" href="editor.html?mode=code"><i data-feather="edit-3"></i> Open Editor</a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Scheduler (shortcut to page) -->
      <div class="card">
        <div style="padding:16px 16px 0 16px">
          <h2>Scheduler</h2><div class="muted">Plan classes and send invites.</div>
        </div>
        <div style="padding:16px">
          <a class="btn primary" href="scheduler.html"><i data-feather="calendar"></i> Open Scheduler</a>
        </div>
      </div>
      <!-- Study Session (shortcut to page) -->
      <div class="card">
        <div style="padding:16px 16px 0 16px">
          <h2>Study Session</h2><div class="muted">Create or join a collaborative session.</div>
        </div>
        <div style="padding:16px;display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn primary" href="session.html"><i data-feather="users"></i> Open Study Session</a>
        </div>
      </div>
    </div>

    <!-- Uploaded Notes & Feedback (full width) -->
    <div class="container">
      <div class="card" id="uploads">
        <div style="padding:16px 16px 0 16px">
          <h2>Uploaded Notes</h2><div class="muted">Open uploaded notes. Add comments or ratings (stored locally).</div>
        </div>
        <div style="padding:16px;max-height:400px;overflow-y:auto" class="list" id="notes-list">
          <div class="list-row" data-note="Data Structures – Arrays & Linked Lists">
            <div><strong>Data Structures – Arrays & Linked Lists</strong><div class="muted" data-state></div></div>
            <div style="display:flex;gap:8px">
              <button class="btn act-open"><i data-feather="file-text"></i> Open</button>
              <button class="btn act-comment"><i data-feather="message-circle"></i> Comment</button>
              <button class="btn act-rate"><i data-feather="star"></i> Rate</button>
            </div>
          </div>
          <div class="list-row" data-note="Operating Systems – Processes & Threads">
            <div><strong>Operating Systems – Processes & Threads</strong><div class="muted" data-state></div></div>
            <div style="display:flex;gap:8px">
              <button class="btn act-open"><i data-feather="file-text"></i> Open</button>
              <button class="btn act-comment"><i data-feather="message-circle"></i> Comment</button>
              <button class="btn act-rate"><i data-feather="star"></i> Rate</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="container foot">
      <span>© <span id="year"></span> NoteHive. All rights reserved.</span>
      <div style="display:flex;gap:10px;align-items:center">
        <a class="btn btn-green" href="help.html"><i data-feather="help-circle"></i> Help</a>
        <button class="btn btn-red" id="btn-logout-foot"><i data-feather="log-out"></i> Logout</button>
      </div>
    </div>
  </footer>

  <!-- Reusable Modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-h"><strong id="modal-title">Modal</strong><button class="btn ghost" id="modal-close">✕</button></div>
      <div class="modal-b" id="modal-body"></div>
      <div class="modal-f" id="modal-foot"></div>
    </div>
  </div>

  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>

  <script>
    const $ = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    feather.replace(); // render icons

    const yearEl = $("#year"); yearEl.textContent = new Date().getFullYear();

    /* -------- Session/auth (localStorage) -------- */
    const authKey = "notehive.auth";
    const currentUserKey = "notehive_current_user";
    
    function getAuth(){ 
      // First check for current user from registration system
      const currentUser = getCurrentUser();
      if (currentUser) {
        return { username: currentUser.username, email: currentUser.email, role: currentUser.role };
      }
      // Fallback to old auth system
      try{return JSON.parse(localStorage.getItem(authKey)||"null")}catch{return null} 
    }
    
    function getCurrentUser() {
      try {
        return JSON.parse(localStorage.getItem(currentUserKey) || "null");
      } catch {
        return null;
      }
    }
    
    function setAuth(v){ localStorage.setItem(authKey, JSON.stringify(v)); renderAuth(); }
    function clearAuth(){ 
      localStorage.removeItem(authKey);
      localStorage.removeItem(currentUserKey);
      renderAuth();
      // Redirect to home page after logout
      window.location.href = 'softwareproject.html';
    }

    function renderAuth(){
      const a = getAuth();
      const currentUser = getCurrentUser();
      const btn = $("#btn-signin");
      const out1 = $("#btn-logout"), out2 = $("#btn-logout-foot");
      const welcomeTitle = $("#welcome-title");
      const welcomeSubtitle = $("#welcome-subtitle");
      
      if(a || currentUser){
        const displayName = currentUser?.fullName || currentUser?.username || a?.username || 'User';
        btn.innerHTML = `<i data-feather="user"></i> ${displayName}`;
        feather.replace({ class: 'icon' });
        btn.classList.remove("btn-blue"); btn.classList.add("ghost");
        out1.disabled = false; out2.disabled = false;
        
        // Update welcome message
        if (welcomeTitle && currentUser?.fullName) {
          welcomeTitle.textContent = `Welcome back, ${currentUser.fullName}!`;
        }
        if (welcomeSubtitle) {
          welcomeSubtitle.textContent = `Professional teacher dashboard for Computer Science courses.`;
        }
      } else {
        btn.innerHTML = `<i data-feather="log-in"></i> Sign in`;
        feather.replace();
        btn.classList.add("btn-blue"); btn.classList.remove("ghost");
        out1.disabled = true; out2.disabled = true;
        
        // Reset welcome message
        if (welcomeTitle) {
          welcomeTitle.textContent = 'Welcome to NoteHive';
        }
        if (welcomeSubtitle) {
          welcomeSubtitle.textContent = 'Professional teacher dashboard for Computer Science courses.';
        }
      }
    }
    
    // Check if user is logged in on page load
    function checkAuth() {
      const currentUser = getCurrentUser();
      if (!currentUser) {
        // No user logged in, redirect to home
        alert('You are not logged in. Redirecting to login page...');
        window.location.href = 'softwareproject.html';
      }
    }

    /* -------- Modal helpers -------- */
    const backdrop = $("#backdrop");
    const modalBody = $("#modal-body");
    const modalFoot = $("#modal-foot");
    const modalTitle = $("#modal-title");
    const openModal = (title, bodyHTML, footHTML) => {
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHTML;
      modalFoot.innerHTML = footHTML || "";
      backdrop.style.display = "flex";
      setTimeout(()=>{ feather.replace(); }, 0);
      setTimeout(()=>{ const first = modalBody.querySelector("input,textarea,select,button"); first && first.focus(); }, 0);
    };
    const closeModal = () => { backdrop.style.display = "none"; };
    $("#modal-close").addEventListener("click", closeModal);
    backdrop.addEventListener("click", e => { if(e.target === backdrop) closeModal(); });

    /* -------- Sign in modal -------- */
    $("#btn-signin").addEventListener("click", ()=>{
      openModal("Sign in to NoteHive", `
        <div class="form">
          <label>Username
            <input class="input" id="si-user" placeholder="e.g., prof_raj"/>
          </label>
          <label>Password
            <input class="input" id="si-pass" type="password" placeholder="••••••••"/>
          </label>
          <label class="muted" style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="si-remember"> Remember me</label>
        </div>
      `, `
        <button class="btn" id="si-cancel"><i data-feather="x"></i> Cancel</button>
        <button class="btn btn-blue" id="si-go"><i data-feather="log-in"></i> Sign in</button>
      `);
      $("#si-cancel").onclick = closeModal;
      $("#si-go").onclick = ()=>{
        const u = ($("#si-user").value||"").trim();
        const p = ($("#si-pass").value||"").trim();
        if(!u || !p){ alert("Please enter username and password."); return; }
        setAuth({username:u, remember: $("#si-remember").checked});
        closeModal();
      };
    });
    $("#btn-logout").addEventListener("click", ()=>{ 
      clearAuth(); 
      alert("Logged out successfully. Redirecting to home page...");
    });
    $("#btn-logout-foot").addEventListener("click", ()=>{ 
      clearAuth(); 
      alert("Logged out successfully. Redirecting to home page...");
    });

    /* -------- Tabs -------- */
    const panels = { docs: $("#p-docs"), check: $("#p-check"), code: $("#p-code") };
    $$(".tab-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        $$(".tab-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        Object.values(panels).forEach(p=>p.classList.remove("active"));
        panels[btn.dataset.panel].classList.add("active");
      });
    });

    /* -------- Quick action scroll shortcuts -------- */
    $("#qa-upload").addEventListener("click", ()=>$("#upload").scrollIntoView({behavior:"smooth"}));

    /* -------- Upload flow (MongoDB) -------- */
    const API_BASE_URL = 'http://localhost:3000'; // Backend server URL
    function showUploadMsg(msg, ok=true){ const el=$("#upload-msg"); el.textContent = msg; el.style.color = ok ? "var(--ok)" : "var(--warn)"; }
    function getToken(){ 
      try {
        const token = localStorage.getItem('token');
        if (token) return token;
        const userStr = localStorage.getItem('notehive_current_user');
        if (userStr) {
          const user = JSON.parse(userStr);
          return user.token || null;
        }
      } catch (e) {
        console.warn("Error parsing token:", e);
      }
      return null;
    }

    $("#btn-upload").addEventListener("click", async ()=>{
      const files = $("#file-input").files;
      const title = $("#title-input").value.trim();
      const subject = $("#subject-select").value;
      const desc = $("#desc-input").value.trim();
      if(!files.length || !title){ showUploadMsg("Select file(s) and enter a title.", false); return; }
      
      const file = files[0];
      const token = getToken();
      showUploadMsg("Uploading file...", true);

      try {
        // Step 1: Upload file to get fileId
        const formData = new FormData();
        formData.append("file", file);
        formData.append("title", title);
        formData.append("subject", subject);
        formData.append("desc", desc);

        const uploadRes = await fetch(`${API_BASE_URL}/api/files/upload`, {
          method: "POST",
          headers: token ? { Authorization: `Bearer ${token}` } : {},
          body: formData
        });
        
        if (!uploadRes.ok) {
          const errorText = await uploadRes.text();
          throw new Error(errorText || `Upload failed with status ${uploadRes.status}`);
        }
        
        const uploadData = await uploadRes.json();
        
        if (!uploadData.success) {
          throw new Error(uploadData.error || "File upload failed");
        }

        const fileId = uploadData.data.file._id;

        // Step 2: Create note in MongoDB with file attachment
        showUploadMsg("Saving note...", true);
        const noteRes = await fetch(`${API_BASE_URL}/api/notes`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {})
          },
          body: JSON.stringify({
            title,
            content: desc || " ",
            subject,
            isPublic: true, // Make uploaded notes public so they're visible to all
            attachments: [{ fileId, filename: file.name }]
          })
        });
        
        if (!noteRes.ok) {
          const errorText = await noteRes.text();
          throw new Error(errorText || `Note creation failed with status ${noteRes.status}`);
        }
        
        const noteData = await noteRes.json();
        
        if (!noteData.success) {
          throw new Error(noteData.error || "Note creation failed");
        }

        showUploadMsg("Uploaded successfully! Visible to all.", true);
        $("#file-input").value = ""; $("#title-input").value=""; $("#desc-input").value="";

        // Reload notes from MongoDB
        loadUploadedNotes();
      } catch (err) {
        showUploadMsg(err.message || "Upload failed", false);
        console.error("Upload error:", err);
      }
    });


    // Load notes from MongoDB
    async function loadUploadedNotes() {
      const notesList = $("#notes-list");
      if (!notesList) return;

      notesList.innerHTML = "<div class='muted'>Loading notes...</div>";
      const token = getToken();

      try {
        const res = await fetch(`${API_BASE_URL}/api/notes`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
        
        if (!res.ok) {
          throw new Error(`Failed to fetch notes: ${res.status} ${res.statusText}`);
        }
        
        const text = await res.text();
        if (!text) {
          throw new Error("Empty response from server");
        }
        
        const data = JSON.parse(text);
        
        if (!data.success) {
          throw new Error(data.error || "Failed to fetch notes");
        }

        const notes = data.data.notes || [];
        
        // Filter out drafts - exclude notes with "(Draft)" in title or isPublic === false
        const uploadedNotes = notes.filter(note => {
          const title = note.title || '';
          const isDraft = title.includes('(Draft)') || note.isPublic === false;
          return !isDraft;
        });
        
        notesList.innerHTML = "";

        if (!uploadedNotes.length) {
          notesList.innerHTML = "<div class='muted'>No notes uploaded yet.</div>";
          return;
        }

        uploadedNotes.forEach(note => {
          const row = document.createElement("div");
          row.className = "list-row";
          row.dataset.noteId = note._id;
          row.dataset.note = note.title;

          const file = (note.attachments && note.attachments[0]) || {};
          const fileUrl = file.fileId?.url || file.url || "#";

          row.innerHTML = `
            <div>
              <strong>${note.title}</strong>
              <div class="muted" data-state>${note.subject || ""} · ${new Date(note.createdAt).toLocaleString()}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn act-open"><i data-feather="file-text"></i> Open</button>
              <button class="btn act-comment"><i data-feather="message-circle"></i> Comment</button>
              <button class="btn act-rate"><i data-feather="star"></i> Rate</button>
              <button class="btn btn-red act-delete"><i data-feather="trash-2"></i> Delete</button>
            </div>
          `;
          notesList.appendChild(row);
        });

        feather.replace();
        renderNoteStates();
      } catch (err) {
        notesList.innerHTML = `<div class='muted'>${err.message || "Failed to load notes."}</div>`;
        console.error("Load notes error:", err);
      }
    }


    /* -------- Uploaded Notes actions (Open/Comment/Rate) -------- */
    const noteStateKey = "notehive.noteStates";
    function getNoteStates(){ try{return JSON.parse(localStorage.getItem(noteStateKey)||"{}")}catch{return {}} }
    function setNoteStates(s){ localStorage.setItem(noteStateKey, JSON.stringify(s)); }
    function renderNoteStates(){
      const states = getNoteStates();
      $$("#notes-list .list-row").forEach(row=>{
        const title = row.dataset.note;
        const el = row.querySelector("[data-state]");
        const st = states[title];
        el.textContent = st ? `Rating: ${st.rating||"-"} · Comments: ${st.comments?.length||0}` : "Published";
      });
    }

    $("#notes-list").addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const row = e.target.closest(".list-row");
      const noteId = row?.dataset.noteId;
      const title = row?.dataset.note || "Note";
      const states = getNoteStates();

      if(btn.classList.contains("act-open")){
        // Fetch note details from MongoDB to get file URL
        const token = getToken();
        try {
          const res = await fetch(`${API_BASE_URL}/api/notes/${noteId}`, {
            headers: token ? { Authorization: `Bearer ${token}` } : {}
          });
          
          if (!res.ok) {
            throw new Error(`Failed to fetch note: ${res.status}`);
          }
          
          const text = await res.text();
          if (!text) {
            throw new Error("Empty response from server");
          }
          
          const data = JSON.parse(text);
          
          if (data.success && data.data.note) {
            const note = data.data.note;
            console.log('Note data:', note);
            const attachment = note.attachments && note.attachments.length > 0 ? note.attachments[0] : null;
            console.log('Attachment:', attachment);
            
            // The fileId should be populated as a full File object
            const file = attachment?.fileId;
            console.log('File object:', file);
            console.log('File object type:', typeof file);
            console.log('File object keys:', file ? Object.keys(file) : 'No file');
            
            const filename = file?.originalName || file?.filename || attachment?.filename || "file";
            
            // Construct full file URL - file.url is relative like /uploads/filename
            let fileUrl = null;
            if (file && typeof file === 'object' && file.url) {
              // If URL is relative, prepend API_BASE_URL
              fileUrl = file.url.startsWith('http') ? file.url : `${API_BASE_URL}${file.url}`;
              console.log('Constructed file URL from file.url:', fileUrl);
            } else if (file && typeof file === 'object' && file.filename) {
              // Fallback: construct URL from filename
              fileUrl = `${API_BASE_URL}/uploads/${file.filename}`;
              console.log('Fallback file URL from file.filename:', fileUrl);
            } else if (attachment?.filename) {
              // Last resort: use attachment filename
              fileUrl = `${API_BASE_URL}/uploads/${attachment.filename}`;
              console.log('Last resort file URL from attachment.filename:', fileUrl);
            } else if (attachment?.fileId && typeof attachment.fileId === 'string') {
              // If fileId is just a string ID, we need to fetch the file separately
              console.log('fileId is a string, need to fetch file:', attachment.fileId);
              // Try to construct URL from fileId (this won't work, but helps debug)
              fileUrl = null;
            }
            
            console.log('Final fileUrl:', fileUrl);

            // Check if note has content (published from editor) or file attachment
            const noteContent = note.content || "";
            const hasContent = noteContent.trim() && noteContent !== " ";
            
            if (fileUrl) {
              // Open the PDF/file in a new tab immediately
              window.open(fileUrl, '_blank', 'noopener');
              return;
            } else if (hasContent) {
              // Note has content (published from editor) - show content
              openModal(title,
                `<div style='max-height:70vh;overflow-y:auto;padding:12px;background:#0f1115;border-radius:8px;border:1px solid var(--line);'>
                  <div style='color:var(--ink);'>${noteContent}</div>
                </div>`,
                `<button class='btn btn-blue' id='open-close'><i data-feather='check'></i> Close</button>`
              );
            } else {
              openModal(title, 
                `<p class='muted'>This note was saved without an attachment or published content. Ask the author to upload the file again.</p>`, 
                `<button class='btn btn-blue' id='open-close'><i data-feather='check'></i> Close</button>`
              );
            }
          } else {
            openModal(title, `<p class='muted'>Could not load note details.</p>`, `<button class='btn btn-blue' id='open-close'><i data-feather='check'></i> Close</button>`);
          }
        } catch (err) {
          openModal(title, `<p class='muted'>Error loading note: ${err.message}</p>`, `<button class='btn btn-blue' id='open-close'><i data-feather='check'></i> Close</button>`);
        }
        $("#open-close").onclick = closeModal;
      }

      if(btn.classList.contains("act-delete")){
        if(!confirm(`Are you sure you want to delete "${title}"? This action cannot be undone.`)) return;
        
        const token = getToken();
        try {
          const res = await fetch(`${API_BASE_URL}/api/notes/${noteId}`, {
            method: "DELETE",
            headers: token ? { Authorization: `Bearer ${token}` } : {}
          });
          
          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(errorText || `Delete failed with status ${res.status}`);
          }
          
          const text = await res.text();
          const data = text ? JSON.parse(text) : { success: true };
          
          if (data.success) {
            showUploadMsg("Note deleted successfully.", true);
            loadUploadedNotes();
          } else {
            throw new Error(data.error || "Delete failed");
          }
        } catch (err) {
          showUploadMsg(err.message || "Failed to delete note", false);
          console.error("Delete error:", err);
        }
      }

      if(btn.classList.contains("act-comment")){
        openModal("Add Comment", `
          <div class="form">
            <div class="muted">${title}</div>
            <textarea class="input" id="cmt-text" placeholder="Write your feedback…"></textarea>
          </div>
        `, `<button class="btn" id="cmt-c"><i data-feather="x"></i> Cancel</button><button class="btn btn-blue" id="cmt-ok"><i data-feather="send"></i> Submit</button>`);
        $("#cmt-c").onclick = closeModal;
        $("#cmt-ok").onclick = ()=>{
          const v = ($("#cmt-text").value||"").trim();
          if(!v){ alert("Please write a comment."); return; }
          const cur = states[title] || {comments:[], rating:null};
          cur.comments.push({ts:Date.now(), text:v}); states[title]=cur; setNoteStates(states); closeModal(); renderNoteStates();
        };
      }

      if(btn.classList.contains("act-rate")){
        openModal("Rate Note", `
          <div class="form">
            <div class="muted">${title}</div>
            <div>
              <label class="muted">Select rating</label>
              <select class="select" id="rate-val">
                <option value="5">★★★★★ (5)</option>
                <option value="4">★★★★☆ (4)</option>
                <option value="3">★★★☆☆ (3)</option>
                <option value="2">★★☆☆☆ (2)</option>
                <option value="1">★☆☆☆☆ (1)</option>
              </select>
            </div>
          </div>
        `, `<button class="btn" id="rate-c"><i data-feather="x"></i> Cancel</button><button class="btn btn-blue" id="rate-ok"><i data-feather="check-circle"></i> Submit</button>`);
        $("#rate-c").onclick = closeModal;
        $("#rate-ok").onclick = ()=>{
          const r = $("#rate-val").value;
          const cur = states[title] || {comments:[], rating:null};
          cur.rating = r; states[title]=cur; setNoteStates(states); closeModal(); renderNoteStates();
        };
      }
    });

    /* -------- Restore persisted UI state on load -------- */
    function restoreSession(){
      const s = sessionStorage.getItem("notehive.session");
      if(!s) return;
      const obj = JSON.parse(s);
      if(obj.active){ /* No banner here—session page shows details */ }
    }
    // Check authentication and render UI
    checkAuth();
    renderAuth(); 
    loadUploadedNotes();
    restoreSession();

    /* -------- New note shortcut -------- */
    $("#btn-new-note").addEventListener("click", ()=>{ location.href = "editor.html?mode=docs&new=1"; });
  </script>
</body>
</html>
