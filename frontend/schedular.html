<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NoteHive — Scheduler</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#15161a; --ink:#f3f4f6; --muted:#a3a6ad; --line:#272a30;
      --blue:#3b82f6; --green:#10b981; --red:#ef4444; --amber:#f59e0b;
      --r:18px; --shadow:0 12px 32px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{text-decoration:none;color:inherit}
    .top{position:sticky;top:0;z-index:10;background:#0b0c10cc;color:#fff;backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #111827}
    .top-inner{max-width:900px;margin:auto;padding:10px 20px;display:flex;align-items:center;gap:12px}
    .logo{width:32px;height:32px;border-radius:10px;background:var(--amber);display:grid;place-items:center;color:#111;font-weight:800}
    .right{margin-left:auto;display:flex;gap:8px}
    .btn{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:#1b1d23;color:var(--ink)}
    .btn i{width:18px;height:18px}
    .btn.primary{background:var(--blue);border-color:transparent}
    .btn.red{background:var(--red);border-color:transparent}
    .wrap{max-width:900px;margin:18px auto;padding:0 20px;display:grid;gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .form{display:grid;gap:10px}
    .input{width:100%;padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1115;color:var(--ink)}
    .row{display:flex;gap:10px}
    .list{display:grid;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:10px;padding:10px;background:#20232a}
    .muted{color:var(--muted)}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .zoom-link{color:var(--blue);text-decoration:underline;margin-top:4px;display:inline-block}
    .zoom-link:hover{color:var(--green)}
    .zoom-success{background:#1a3a2e;border:1px solid #10b981;border-radius:10px;padding:12px;margin-top:10px}
    .zoom-success-link{display:flex;align-items:center;gap:8px;margin-top:8px;padding:10px;background:#0f1115;border-radius:8px;border:1px solid var(--line)}
    .zoom-success-link a{color:var(--blue);text-decoration:none;flex:1;word-break:break-all}
    .zoom-success-link a:hover{color:var(--green);text-decoration:underline}
    .copy-btn{background:var(--green);border:none;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px}
    .copy-btn:hover{background:#059669}
    .copy-btn:active{transform:scale(0.95)}
    .zoom-badge{display:inline-flex;align-items:center;gap:6px;background:var(--blue);color:#fff;padding:4px 10px;border-radius:6px;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <header class="top">
    <div class="top-inner">
      <div class="logo">NH</div>
      <div>Scheduler</div>
      <div class="right">
        <a class="btn" href="index.html"><i data-feather="arrow-left"></i> Back</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Create Class</h2>
      <div class="form">
        <input class="input" id="title" placeholder="Class title (e.g., OS – CPU Scheduling)"/>
        <div class="row">
          <input type="date" class="input" id="date" style="flex:1">
          <input type="time" class="input" id="time" style="flex:1">
        </div>
        <div class="row" style="align-items:center">
          <label class="muted" style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="net-stable" checked> Network stable?</label>
          <span style="flex:1"></span>
          <button class="btn primary" id="create"><i data-feather="calendar"></i> Schedule</button>
        </div>
        <div id="msg" class="muted"></div>
        <div id="zoom-success" style="display:none"></div>
      </div>
    </section>

    <section class="card">
      <h2>Upcoming Classes</h2>
      <div id="list" class="list"></div>
      <div class="muted">Items persist in your browser.</div>
    </section>
  </main>

  <script src="https://unpkg.com/feather-icons"></script>
  <script>
    feather.replace();
    const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];
    const key="notehive.schedule";
    
    // Backend API URL - change this to your backend server URL
    const API_BASE_URL = 'http://localhost:3000';
    // For production, use: const API_BASE_URL = 'https://your-backend-domain.com';

    function getAll(){ try{return JSON.parse(localStorage.getItem(key)||"[]")}catch{return []} }
    function setAll(v){ localStorage.setItem(key, JSON.stringify(v)); }
    
    function render(){
      const list=$("#list"); list.innerHTML="";
      const arr=getAll();
      if(!arr.length){ list.innerHTML = `<div class="muted">No classes scheduled yet.</div>`; return; }
      arr.forEach((it,idx)=>{
        const row=document.createElement("div");
        row.className="item";
        const zoomInfo = it.zoomMeeting ? 
          `<div style="margin-top:8px">
            <div class="zoom-badge">
              <i data-feather="video"></i> Zoom Meeting Ready
            </div>
            <div style="margin-top:8px;padding:10px;background:#0f1115;border-radius:8px;border:1px solid var(--line)">
              <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Join URL:</div>
              <a href="${it.zoomMeeting.join_url}" target="_blank" style="color:var(--blue);text-decoration:none;word-break:break-all;display:block" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                ${it.zoomMeeting.join_url}
              </a>
              ${it.zoomMeeting.password ? `<div style="font-size:12px;color:var(--muted);margin-top:8px">Password: <strong style="color:var(--ink)">${it.zoomMeeting.password}</strong></div>` : ''}
              ${it.zoomMeeting.meeting_number ? `<div style="font-size:12px;color:var(--muted);margin-top:4px">Meeting ID: <strong style="color:var(--ink)">${it.zoomMeeting.meeting_number}</strong></div>` : ''}
            </div>
          </div>` : '';
        row.innerHTML=`<div style="flex:1">
          <div><strong>${it.title}</strong></div>
          <div class="muted">${it.date} • ${it.time}</div>
          ${zoomInfo}
        </div>
        <div style="display:flex;gap:8px;align-items:flex-start">
          ${it.zoomMeeting?.join_url ? `<a href="${it.zoomMeeting.join_url}" target="_blank" class="btn primary"><i data-feather="video"></i> Join</a>` : ''}
          <button class="btn red" data-del="${idx}"><i data-feather="trash-2"></i> Delete</button>
        </div>`;
        list.appendChild(row);
      });
      feather.replace();
    }

    async function createZoomMeeting(meetingData){
      try {
        const response = await fetch(`${API_BASE_URL}/api/zoom/create-meeting`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(meetingData)
        });
        
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('Error creating Zoom meeting:', error);
        return {
          success: false,
          error: 'Failed to connect to server. Make sure the backend is running.'
        };
      }
    }

    $("#create").addEventListener("click", async ()=>{
      const t=$("#title").value.trim(), d=$("#date").value, tm=$("#time").value;
      if(!t || !d || !tm){ 
        $("#msg").textContent="Fill in title, date and time."; 
        $("#msg").style.color="#f97316"; 
        return; 
      }
      
      const createBtn = $("#create");
      const originalText = createBtn.innerHTML;
      const zoomSuccess = $("#zoom-success");
      zoomSuccess.style.display = "none"; // Hide previous success messages
      createBtn.disabled = true;
      createBtn.innerHTML = '<i data-feather="loader"></i> Creating...';
      feather.replace();
      
      if($("#net-stable").checked){
        try {
          // Create Zoom meeting via backend API
          const zoomResult = await createZoomMeeting({
            title: t,
            date: d,
            time: tm,
            duration: 60 // Default 60 minutes
          });
          
          if(zoomResult.success){
            // Save to localStorage with Zoom meeting info
            const arr=getAll(); 
            arr.push({
              title: t,
              date: d,
              time: tm,
              zoomMeeting: {
                join_url: zoomResult.joinUrl || zoomResult.join_url,
                meeting_number: zoomResult.meetingId || zoomResult.meeting_number,
                password: zoomResult.password || '',
                start_url: zoomResult.startUrl || zoomResult.start_url
              }
            });
            setAll(arr);
            render();
            // Show Zoom link to user
            zoomSuccess.style.display = "block";
            zoomSuccess.innerHTML = `<div class='zoom-success'>Meeting scheduled!<br>Zoom link: <a href='${zoomResult.joinUrl || zoomResult.join_url}' target='_blank' class='zoom-link'>${zoomResult.joinUrl || zoomResult.join_url}</a></div>`;
            createBtn.disabled = false;
            createBtn.innerHTML = originalText;
            feather.replace();
          } else {
            zoomSuccess.style.display = "block";
            zoomSuccess.innerHTML = `<div class='zoom-success' style='color:#ef4444'>Error: ${zoomResult.error || 'Could not create Zoom meeting.'}</div>`;
            createBtn.disabled = false;
            createBtn.innerHTML = originalText;
            feather.replace();
          }
        } catch (error) {
          // Fallback: save locally if API call fails
          zoomSuccess.style.display = "none"; // Hide success box on error
          const arr=getAll(); 
          arr.push({title:t,date:d,time:tm}); 
          setAll(arr);
          $("#msg").textContent="Meeting saved locally. Zoom integration unavailable (backend may be offline)."; 
          $("#msg").style.color="#f97316";
          render();
        }
      } else {
        // Network unstable - save locally only
        zoomSuccess.style.display = "none"; // Hide success box
        const arr=getAll(); 
        arr.push({title:t,date:d,time:tm}); 
        setAll(arr);
        $("#msg").textContent="Network unstable. Draft saved locally. Try again when stable."; 
        $("#msg").style.color="#f97316";
        render();
      }
      
      createBtn.disabled = false;
      createBtn.innerHTML = originalText;
      feather.replace();
    });

    $("#list").addEventListener("click",(e)=>{
      const btn=e.target.closest("button"); if(!btn) return;
      if(btn.dataset.del){
        const idx=+btn.dataset.del; const arr=getAll(); arr.splice(idx,1); setAll(arr); render();
      }
    });

    // Copy to clipboard function
    function copyToClipboard(text, btnElement) {
      navigator.clipboard.writeText(text).then(() => {
        // Show temporary feedback
        if(btnElement) {
          const originalHTML = btnElement.innerHTML;
          btnElement.innerHTML = '<i data-feather="check"></i> Copied!';
          btnElement.style.background = '#10b981';
          feather.replace();
          setTimeout(() => {
            btnElement.innerHTML = originalHTML;
            btnElement.style.background = '';
            feather.replace();
          }, 2000);
        } else {
          // Fallback: show alert if button not found
          alert('Copied to clipboard!');
        }
      }).catch(err => {
        console.error('Failed to copy:', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          if(btnElement) {
            const originalHTML = btnElement.innerHTML;
            btnElement.innerHTML = '<i data-feather="check"></i> Copied!';
            btnElement.style.background = '#10b981';
            feather.replace();
            setTimeout(() => {
              btnElement.innerHTML = originalHTML;
              btnElement.style.background = '';
              feather.replace();
            }, 2000);
          }
        } catch (e) {
          alert('Failed to copy. Please copy manually.');
        }
        document.body.removeChild(textArea);
      });
    }
    
    // Handle copy button clicks
    document.addEventListener('click', (e) => {
      if(e.target.closest('.copy-btn')) {
        const btn = e.target.closest('.copy-btn');
        const text = btn.dataset.copy;
        if(text) {
          copyToClipboard(text, btn);
        }
      }
    });

    render();
  </script>
</body>
</html>
