<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NoteHive — Scheduler</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#15161a; --ink:#f3f4f6; --muted:#a3a6ad; --line:#272a30;
      --blue:#3b82f6; --green:#10b981; --red:#ef4444; --amber:#f59e0b;
      --r:18px; --shadow:0 12px 32px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{text-decoration:none;color:inherit}
    .top{position:sticky;top:0;z-index:10;background:#0b0c10cc;color:#fff;backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #111827}
    .top-inner{max-width:900px;margin:auto;padding:10px 20px;display:flex;align-items:center;gap:12px}
    .logo{width:32px;height:32px;border-radius:10px;background:var(--amber);display:grid;place-items:center;color:#111;font-weight:800}
    .right{margin-left:auto;display:flex;gap:8px}
    .btn{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:#1b1d23;color:var(--ink)}
    .btn i{width:18px;height:18px}
    .btn.primary{background:var(--blue);border-color:transparent}
    .btn.red{background:var(--red);border-color:transparent}
    .wrap{max-width:900px;margin:18px auto;padding:0 20px;display:grid;gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .form{display:grid;gap:10px}
    .input{width:100%;padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1115;color:var(--ink)}
    .row{display:flex;gap:10px}
    .list{display:grid;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:10px;padding:10px;background:#20232a}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header class="top">
    <div class="top-inner">
      <div class="logo">NH</div>
      <div>Scheduler</div>
      <div class="right">
        <a class="btn" href="index.html"><i data-feather="arrow-left"></i> Back</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Create Class</h2>
      <div class="form">
        <input class="input" id="title" placeholder="Class title (e.g., OS – CPU Scheduling)"/>
        <div class="row">
          <input type="date" class="input" id="date" style="flex:1">
          <input type="time" class="input" id="time" style="flex:1">
        </div>
        <div class="row" style="align-items:center">
          <label class="muted" style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="net-stable" checked> Network stable?</label>
          <span style="flex:1"></span>
          <button class="btn primary" id="create"><i data-feather="calendar"></i> Schedule</button>
        </div>
        <div id="msg" class="muted"></div>
      </div>
    </section>

    <section class="card">
      <h2>Upcoming Classes</h2>
      <div id="list" class="list"></div>
      <div class="muted">Items persist in your browser.</div>
    </section>
  </main>

  <script src="https://unpkg.com/feather-icons"></script>
  <script>
    feather.replace();
    const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];
    const key="notehive.schedule";
    const API_BASE_URL = 'http://localhost:3000'; // Backend server URL
    
    // Get token from localStorage or sessionStorage
    function getToken() {
      return localStorage.getItem('token') || sessionStorage.getItem('token') || null;
    }

    function getAll(){ try{return JSON.parse(localStorage.getItem(key)||"[]")}catch{return []} }
    function setAll(v){ localStorage.setItem(key, JSON.stringify(v)); }
    function render(){
      const list=$("#list"); list.innerHTML="";
      const arr=getAll();
      if(!arr.length){ list.innerHTML = `<div class="muted">No classes scheduled yet.</div>`; return; }
      arr.forEach((it,idx)=>{
        const row=document.createElement("div");
        row.className="item";
        let zoomInfo = '';
        if (it.zoomMeeting && it.zoomMeeting.join_url) {
          zoomInfo = `<div style='margin-top:6px'><a href='${it.zoomMeeting.join_url}' target='_blank' style='color:var(--blue);text-decoration:underline;'>Zoom Link</a></div>`;
        }
        row.innerHTML=`<div><strong>${it.title}</strong><div class="muted">${it.date} • ${it.time}</div>${zoomInfo}</div>
                       <div style="display:flex;gap:8px"><button class="btn red" data-del="${idx}"><i data-feather="trash-2"></i> Delete</button></div>`;
        list.appendChild(row);
      });
      feather.replace();
    }


    $("#list").addEventListener("click",(e)=>{
      const btn=e.target.closest("button"); if(!btn) return;
      if(btn.dataset.del){
        const idx=+btn.dataset.del; const arr=getAll(); arr.splice(idx,1); setAll(arr); render();
      }
    });

    $("#create").addEventListener("click", async ()=>{
      const t=$("#title").value.trim(), d=$("#date").value, tm=$("#time").value;
      const msgDiv = $("#msg");
      msgDiv.textContent = "";
      if(!t || !d || !tm){ msgDiv.textContent="Please fill all fields."; msgDiv.style.color="#f97316"; return; }
      if($("#net-stable").checked){
        // Get user info and token
        let user = null;
        try {
          user = JSON.parse(localStorage.getItem('notehive_current_user') || sessionStorage.getItem('user') || 'null');
        } catch {}
        
        const token = getToken();
        if (!user || !user.id || !token) {
          msgDiv.textContent = 'You must be logged in to schedule. Please sign in first.';
          msgDiv.style.color = '#f97316';
          return;
        }
        
        // Create Zoom meeting and save in backend
        let zoomRes;
        try {
          msgDiv.textContent = 'Creating Zoom meeting...';
          msgDiv.style.color = '#3b82f6';
          
          const response = await fetch(`${API_BASE_URL}/api/zoom/create-meeting`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ title: t, date: d, time: tm, duration: 30 })
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: errorText || `HTTP ${response.status}` };
            }
            throw new Error(errorData.error || errorData.message || 'Failed to create meeting');
          }
          
          zoomRes = await response.json();
          if (!zoomRes.success) {
            throw new Error(zoomRes.error || 'Zoom API error');
          }
        } catch (err) {
          console.error('Zoom meeting creation error:', err);
          msgDiv.textContent = 'Error scheduling Zoom meeting: ' + err.message;
          msgDiv.style.color = '#ef4444';
          return;
        }
        // Save to localStorage with Zoom meeting info
        const arr=getAll(); 
        arr.push({
          title: t,
          date: d,
          time: tm,
          zoomMeeting: {
            join_url: zoomRes.joinUrl || zoomRes.join_url,
            meeting_number: zoomRes.meetingId || zoomRes.meeting_number,
            password: zoomRes.password || '',
            start_url: zoomRes.startUrl || zoomRes.start_url
          }
        });
        setAll(arr);
        render();
        // Show Zoom link to user
        msgDiv.innerHTML = `<span style='color:var(--green)'>Meeting scheduled! Zoom link: <a href='${zoomRes.joinUrl || zoomRes.join_url}' target='_blank'>${zoomRes.joinUrl || zoomRes.join_url}</a></span>`;
        $("#title").value=""; $("#date").value=""; $("#time").value="";
      } else {
        msgDiv.textContent="Network unstable. Draft saved locally. Try again when stable."; msgDiv.style.color="#f97316";
      }
    });

    render();
  </script>
</body>
</html>
